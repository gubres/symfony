{% extends 'base.html.twig' %}

{% block title %}FAMOSOS{% endblock %}

{% block body %}
<div class="container mt-4">

{% if is_granted('ROLE_ADMIN') %}
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#miModal">
        Insertar Datos
    </button>
{% endif %}

    {% block modales %}
        {# Ventana Modal para insertar datos #}
        <div class="modal fade" id="miModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">INSERIR FAMOSO✅</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                        <div class="modal-body">
                        {{ form_start(form, {'attr': {'id': 'miFormulario', 'class': 'w-100'}}) }}
                        
                        {% include '/main/formulario.html.twig' %}

                        {{ form_end(form) }}
                    </div>
                    <div class="modal-footer">
                        <button type="reset" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" id="confirmarEnvio" class="btn btn-primary">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        {# Ventana Modal para actualizar datos #}
        <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">EDITAR FAMOSO✅</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="editarModalBody">

                     {% include '/main/editarForm.html.twig' %}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" form="editarForm" class="btn btn-primary">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-body">
            {% include '/famosos/datostabla.html.twig' %}
        </div>
    {% endblock %}
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>

$(document).ready(function() {
     $('#miModal').on('show.bs.modal', function(e) {
        // Resetea el formulario completo dejando sin datos
        $('#miFormulario').trigger('reset');
    });

    // cuando el modal está completamente abierto enfoca el primer campo
    $('#miModal').on('shown.bs.modal', function(e) {
        $('#miFormulario input:first').focus();
    });

    $('#editarModal').on('show.bs.modal', function(e) {
        // Resetea el formulario de edicion completamente para poder visualizar el nuevo dato
        $('#editarForm  ').trigger('reset');
    });


    // ese evento carga los datos del famoso en el formulario
    $(document).on('click', '.editarBtn', function() {
        const famosoId = $(this).data('id');
        const url = `/info/${famosoId}`;

        // aqui se hace una solicitud para obtener los datos del famoso
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta');
                }
                return response.json();
            })
            .then(data => {
                // aqui se rellena el formulario con los datos obtenidos
                $('#id_famoso').val(data.id);
                $('#inputNombre').val(data.nombre);
                $('#inputApellido').val(data.apellido);
                $('#inputProfesion').val(data.profesion);

                // se muestra la ventana modal con el formulario rellenado
                $('#editarModal').modal('show');
            })
            .catch(error => console.error('Error:', error));
    });

    // Manejo del evento de envío del formulario de edición
    $('#editarForm').on('submit', function(e) {
        e.preventDefault();

        var nombre = $('#inputNombre').val().trim();
        var apellido = $('#inputApellido').val().trim();
        var profesion = $('#inputProfesion').val().trim();
        
        // una regex para validar que el texto contenga solo letras y espacios
        var regex = /^[A-Za-z\s]+$/;
        
        if (!nombre || !apellido || !profesion) {
            alert('Todos los campos son obligatorios.');
            return;
        }
        if (!regex.test(nombre) || !regex.test(apellido) || !regex.test(profesion)) {
            alert('Nombre, apellido y profesión solo deben contener letras y espacios.');
            return;
        }
        const famosoId = $('#id_famoso').val();
        const formData = new FormData(this);

        fetch(`/editar/${famosoId}`, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                $('#editarModal').modal('hide');
                alert('Famoso actualizado con éxito.');
                $('#famososTabla').DataTable().ajax.reload();
            } else {
                alert('Hubo un error al actualizar el famoso.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al enviar los datos. Intente nuevamente.');
        });
    });
});


    $(document).ready(function() {
    // función para la inserción de un nuevo famoso
    document.getElementById('confirmarEnvio').addEventListener('click', function (e) {
        e.preventDefault();

        // validación de los campos
        let nombre = $("#miModal form").find("input[name*='nombre']").val().trim();
        let apellido = $("#miModal form").find("input[name*='apellido']").val().trim();
        let profesion = $("#miModal form").find("input[name*='profesion']").val().trim();

        // regex para validar que los campos contengan solo letras y espacios
        let regex = /^[A-Za-z\s]+$/;

        if (!nombre || !apellido || !profesion) {
            alert('Todos los campos son obligatorios.');
            return;
        }

        if (!regex.test(nombre) || !regex.test(apellido) || !regex.test(profesion)) {
            alert('Nombre, apellido y profesión solo deben contener letras y espacios.');
            return;
        }

        const formData = new FormData(document.querySelector('#miModal form'));

        fetch('{{ path("form_datos") }}', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                $('#miModal').modal('hide'); 
                mostrarModalConfirmacion('Los datos han sido enviados exitosamente.');
                $('#famososTabla').DataTable().ajax.reload();
            } else {
                $('#miModal').modal('hide');
                mostrarModalConfirmacion('Error al enviar los datos. Por favor, intente nuevamente.');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            mostrarModalConfirmacion('Error al enviar los datos. Por favor, intente nuevamente.');
        });
    });
});

    //evento para borrar un dato de famoso
    $(document).ready(function() {
    $(document).on('click', '.btnDelete', function(event){
        event.preventDefault();
        let id = $(this).data('id');
        let nombre = $(this).data('nombre');
        
        if(confirmDelete(nombre)) {
            $.ajax({
            url: `/main/index/${id}`,
            method: 'GET', 
            success: function(response) {
                if (response.success) {
                    console.log('Famoso eliminado con éxito');
                    $('#famososTabla').DataTable().ajax.reload(null, false);
                } else {
                    console.error('Error al eliminar el famoso');
                }
            },
            error: function(error) {
                console.error('Error al eliminar el famoso', error);
            }
        });
        }
    });
});

    function confirmDelete(nombre) {
        return confirm(`¿Está seguro? Esta acción irá borrar el dato "${nombre}".`);
    };
    function mostrarModalConfirmacion(mensaje) {
        alert(mensaje); 
    };
    function configurarBotones() {
        return [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Exportar a Excel',
                className: 'btn btn-success',
                title: 'Datos de Famosos',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                }
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> Exportar a PDF',
                className: 'btn btn-danger',
                title: 'Datos de Famosos',
                orientation: 'portrait',
                pageSize: 'A4',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                },
                customize: function(doc) {
                    // Centrar la tabla en la página PDF
                    var docContent = doc.content[1];
                    docContent.margin = [ 0, 0, 0, 0 ]; // [left, top, right, bottom]
                    docContent.table.widths = Array(docContent.table.body[0].length + 1).join('*').split('');
                    // En ese apartado se puede ajustar para cambiar la posición de la tabla horizontalmente
                    docContent.layout = {
                        hLineWidth: function(i, node) {
                            return 0.5;
                        },
                        vLineWidth: function(i, node) {
                            return 0.5;
                        },
                        hLineColor: function(i, node) {
                            return '#aaa';
                        },
                        vLineColor: function(i, node) {
                            return '#aaa';
                        },
                        paddingLeft: function(i, node) {
                            return 4;
                        },
                        paddingRight: function(i, node) {
                            return 4;
                        },
                        paddingTop: function(i, node) {
                            return 2;
                        },
                        paddingBottom: function(i, node) {
                            return 2;
                        }
                    };
                }
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Imprimir',
                className: 'btn btn-info',
                title: 'Datos de Famosos',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                }
            },
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> Copiar',
                className: 'btn btn-primary',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                }
            }
        ];
    }


$(document).ready(function() {
     $('#famososTabla').DataTable({
        "processing": true,
        "serverSide": true,
        "responsive": true, // Hace que la tabla sea responsive
        "autoWidth": false, // Deshabilita el ajuste automático del ancho de columnas
        "ajax": "{{ path('datos_tabla') }}",
        "columns": [
            { "data": "id" },
            { "data": "nombre" },
            { "data": "apellido" },
            { "data": "profesion" },
            { "data": "editar", "orderable": false },
            { "data": "borrar", "orderable": false }
            ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.20/i18n/Spanish.json'
        },  dom: '<"row"<"col-sm-3"l><"col-sm-5"B><"col-sm-3"f>>rt<"row"<"col-sm-7"p><"col-sm-5"i>>',
        buttons: configurarBotones()
    });

     $('#miFormulario').submit(function(e) {
            e.preventDefault();
            alert('Datos enviados!');
            this.submit();
            
        });
    $('#editarFormulario').submit(function(e) {
            e.preventDefault();
            alert('Datos actualizados!');
            this.submit();
            
        });
});

    </script>
{% endblock %}