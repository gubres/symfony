{% extends 'base.html.twig' %}

{% block title %}Usuarios{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mt-3 mb-5 text-center">LISTADO DE USUARIOS ✅</h1>
    <table id="userTabla" class="table table-bordered">
        <thead>
            <tr>
                <th class="text-center">ID</th>
                <th class="text-center">Email</th>
                <th class="text-center">Roles</th>
                <th class="text-center">Editar role</th>
                <th class="text-center">Eliminar usuario</th>
            </tr>
        </thead>
        <tbody class="text-center">
          
        </tbody>
    </table>

            {# modal de mensajes #}
        <div class="modal-body">
            {% include '/user/modalUser.html.twig' %}
        </div>
{% endblock %}


{% block javascripts %}

    {{ parent() }}
<script>

  $(document).ready(function() {
    var userTabla = $('#userTabla').DataTable({
        "processing": true,
        "serverSide": false,  // Asegúrate de ajustar esto según la configuración de tu servidor
        "ajax": {
            "url": "{{ path('user_data') }}",
            "type": "GET"
        },
        "columns": [
            { "data": "id" },
            { "data": "email" },
            { "data": "roles" },
            { "data": "editar" },
            { "data": "borrar" }
        ],
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.10.20/i18n/Spanish.json"
        },
        "dom": '<"row"<"col-sm-3"l><"col-sm-5"B><"col-sm-3"f>>rt<"row"<"col-sm-7"p><"col-sm-5"i>>',
        buttons: configurarBotones()
    });

    $('#userTabla tbody').on('click', 'button', function() {
        var data = userTabla.row($(this).parents('tr')).data();
        if($(this).hasClass('edit-button')) {
            // Llenar el formulario de edición con los datos
            $('#editModal').modal('show');
        } else if($(this).hasClass('delete-button')) {
            // Preparar y mostrar modal de confirmación de eliminación
            $('#deleteModal').modal('show');
        }
    });

        //manejo del modal editar
        $('#editModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var id = button.data('id');
        var email = button.data('email');
        var roles = button.data('roles').split(',');

        var modal = $(this);
        modal.find('.modal-title').text('Editar Usuario: ' + email);
        modal.find('.modal-body #userId').val(id);
        modal.find('.modal-body #userEmail').val(email);

        modal.find('.modal-body #userRoles').find('option').each(function() {
            $(this).prop('selected', roles.includes($(this).val()));
        });
    });

    $('#editUserForm').on('submit', function(e) {
        e.preventDefault();
        var formData = $(this).serialize();
        $.ajax({
            url: '{{ path("update_user") }}',
            type: 'POST',
            data: formData,
            success: function(response) {
                $('#editModal').modal('hide');
                mostrarSuccessModal('Role del usuario modificado correctamente');
                userTabla.ajax.reload();
            },
            error: function() {
                mostrarErrorModal('Error al actualizar el usuario.');
            }
        });
    });

    $('#deleteModal').on('show.bs.modal', function(e) {
        var button = $(e.relatedTarget);
        var id = button.data('id');
        $('#confirmDeleteButton').off('click').on('click', function() {
            $.ajax({
                url: '{{ path("delete_user") }}',
                type: 'POST',
                data: { userId: id },
                success: function(response) {
                    $('#deleteModal').modal('hide');
                    mostrarSuccessModal('Usuario eliminado correctamente');
                    userTabla.ajax.reload();
                },
                error: function() {
                    mostrarErrorModal('Error al eliminar el usuario.');
                }
            });
        });
    });

    function mostrarSuccessModal(mensaje) {
        $('#successModalText').text(mensaje);
        $('#successModal').modal('show');
    }

    function mostrarErrorModal(mensaje) {
        $('#errorModalText').text(mensaje); 
        $('#errorModal').modal('show'); 
    }
});

function configurarBotones() {
        return [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Exportar a Excel',
                className: 'btn btn-success',
                title: 'LISTADO DE USUARIOS',
                exportOptions: {
                    columns: [0, 1, 2]
                }
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> Exportar a PDF',
                className: 'btn btn-danger',
                title: 'LISTADO DE USUARIOS',
                orientation: 'portrait',
                pageSize: 'A4',
                exportOptions: {
                    columns: [0, 1, 2]
                },
                customize: function(doc) {
                    // Centrar la tabla en la página PDF
                    var docContent = doc.content[1];
                    docContent.margin = [ 0, 0, 0, 0 ]; // [left, top, right, bottom]
                    docContent.table.widths = Array(docContent.table.body[0].length + 1).join('*').split('');
                    // En ese apartado se puede ajustar para cambiar la posición de la tabla horizontalmente
                    docContent.layout = {
                        hLineWidth: function(i, node) {
                            return 0.5;
                        },
                        vLineWidth: function(i, node) {
                            return 0.5;
                        },
                        hLineColor: function(i, node) {
                            return '#aaa';
                        },
                        vLineColor: function(i, node) {
                            return '#aaa';
                        },
                        paddingLeft: function(i, node) {
                            return 4;
                        },
                        paddingRight: function(i, node) {
                            return 4;
                        },
                        paddingTop: function(i, node) {
                            return 2;
                        },
                        paddingBottom: function(i, node) {
                            return 2;
                        }
                    };
                }
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Imprimir',
                className: 'btn btn-info',
                title: 'LISTADO DE USUARIOS',
                exportOptions: {
                    columns: [0, 1, 2]
                }
            },
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> Copiar',
                className: 'btn btn-primary',
                exportOptions: {
                    columns: [0, 1, 2]
                }
            }
        ];
    }
</script>
{% endblock %}
